<!DOCTYPE html>
<html>
  <head>
    <title>3D Test</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="/js/lib/binary-parser.js"></script>
    <script src="/js/lib/lib3ds.js"></script>
    <script src="/js/lib/three.min.js"></script>
    <style>
      #log-container {
        position: fixed;
        right: 0;
        top: 0;
        width: 50%;
        height: 500px;
        padding: 10px;
        background-color: rgba(225, 225, 225, 0.5);
        overflow: scroll;
        display:none;
      }
    </style>
  </head>
  <body>
    <script>
      var URL = "/poly_001.3ds";

      var lib3ds;
      var camera, scene, renderer;
      var i = 0;

      function log(message) {
        console.log(message);
        $("#log").append(message + "<br>");
      }

      function loading(is_loading) {
        $("#loading-indicator").css("display", is_loading ? "block" : "none");
      }

      function submit() {
        log("sending request");

        $.ajax({
          url: URL,
          beforeSend: function ( xhr ) {
            xhr.overrideMimeType("text/plain; charset=x-user-defined");
          },
          success: function (responseText) {
            var debugDiv = document.getElementById("log")
            lib3ds = new Lib3ds(debugDiv,
                                false, // debug?
                                responseText);

            // read the 3DS
            log("starting to read");
            var start = new Date();
            lib3ds.readFile();
            log("finished reading in " + (new Date() - start));

            init();
            animate();
          },
        });

        function init() {
          log('starting to draw');
          var start = new Date();
          camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 10000 );
          camera.position.z = 100;

          scene = new THREE.Scene();
          scene.scale = new THREE.Vector3(60, 60, 60);
          scene.updateMatrix();

          for (var i = 0; i < lib3ds.meshes.length; i++) {
            addMesh(lib3ds.meshes[i]);
          }

          var light = new THREE.PointLight(0xffffff, 100);
          light.position.set(100, 100, 150);
          scene.add(light);
          var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
          directionalLight.position.set( 0, 1, 0 );
          scene.add( directionalLight );

          renderer = new THREE.WebGLRenderer();
          renderer.setSize(window.innerWidth, window.innerHeight);
          document.body.appendChild( renderer.domElement );

          log("finished drawing in " + (new Date() - start));
        }

        function addMesh(lib3dsMesh) {
          var geometry = createGeometry(lib3dsMesh);
          var material = new THREE.MeshBasicMaterial({
            color: 0xFF0000,
            wireframe: true
          });
          var mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);
        }

        function animate() {
          // note: three.js includes requestAnimationFrame shim
          requestAnimationFrame( animate );

          scene.rotation.x += 0.001;
          scene.rotation.y += 0.002;
          scene.updateMatrix();

          renderer.render( scene, camera );
        }

        function createGeometry(lib3dsMesh) {
          var geometry = new THREE.Geometry();
          for (var i = 0; i < lib3dsMesh.points; i++) {
            var point = lib3dsMesh.pointL[i];
            geometry.vertices.push(
              new THREE.Vector3(point[0], point[1], point[2]));
            geometry.faceVertexUvs[0].push(new THREE.Vector2(
              lib3dsMesh.texelL[i][0], lib3dsMesh.texelL[i][1]));
          }
          geometry.uvsNeedUpdate = true;

          for (var i = 0; i < lib3dsMesh.faces; i++) {
            var face = lib3dsMesh.faceL[i];
            geometry.faces.push(
              new THREE.Face3(face.points[0], face.points[1], face.points[2]));
          }
          geometry.computeBoundingSphere();
          return geometry;
        }
      }
    </script>
    <form action="javascript:submit();">
      <input type="submit" value="Go!"/>
    </form>
    <div id="log-container">Log:<pre id="log"></pre></div>
    <div id="loading-indicator" style="display:none">Loading...</div>
    <div id="output"></div>
  </body>
</html>